name: workflow â€” trigger comanda production deployment

on:
  push:
    branches: [master]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      subscriptions: ${{ steps.filter.outputs.subscriptions }}
      stores: ${{ steps.filter.outputs.stores }}
      profiles: ${{ steps.filter.outputs.profiles }}
      payments: ${{ steps.filter.outputs.payments }}
      orders: ${{ steps.filter.outputs.orders }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            subscriptions:
              - 'Boundaries/Comanda.Subscriptions/**'
            stores:
              - 'Boundaries/Comanda.Stores/**'
            profiles:
              - 'Boundaries/Comanda.Profiles/**'
            payments:
              - 'Boundaries/Comanda.Payments/**'
            orders:
              - 'Boundaries/Comanda.Orders/**'
            orchestrator:
              - 'Boundaries/Comanda.Orchestrator/**'

  deploy-subscriptions:
    needs: changes
    if: needs.changes.outputs.subscriptions == 'true'
    uses: ./.github/workflows/deploy-pipeline.yml
    with:
      service_path: Boundaries/Comanda.Subscriptions
      image_name: httpsrichardy/comanda.subscriptions
      deploy_url_secret: SUBSCRIPTIONS_PRODUCTION_DEPLOY_URL
    secrets: inherit

  deploy-stores:
    needs: changes
    if: needs.changes.outputs.stores == 'true'
    uses: ./.github/workflows/deploy-pipeline.yml
    with:
      service_path: Boundaries/Comanda.Stores
      image_name: httpsrichardy/comanda.stores
      deploy_url_secret: STORES_PRODUCTION_DEPLOY_URL
    secrets: inherit

  deploy-profiles:
    needs: changes
    if: needs.changes.outputs.profiles == 'true'
    uses: ./.github/workflows/deploy-pipeline.yml
    with:
      service_path: Boundaries/Comanda.Profiles
      image_name: httpsrichardy/comanda.profiles
      deploy_url_secret: PROFILES_PRODUCTION_DEPLOY_URL
    secrets: inherit

  deploy-payments:
    needs: changes
    if: needs.changes.outputs.payments == 'true'
    uses: ./.github/workflows/deploy-pipeline.yml
    with:
      service_path: Boundaries/Comanda.Payments
      image_name: httpsrichardy/comanda.payments
      deploy_url_secret: PAYMENTS_PRODUCTION_DEPLOY_URL
    secrets: inherit

  deploy-orders:
    needs: changes
    if: needs.changes.outputs.orders == 'true'
    uses: ./.github/workflows/deploy-pipeline.yml
    with:
      service_path: Boundaries/Comanda.Orders
      image_name: httpsrichardy/comanda.orders
      deploy_url_secret: ORDERS_PRODUCTION_DEPLOY_URL
    secrets: inherit

  deploy-orchestrator:
    needs: changes
    if: needs.changes.outputs.orchestrator == 'true'
    uses: ./.github/workflows/deploy-pipeline.yml
    with:
      service_path: Boundaries/Comanda.Orchestrator
      image_name: httpsrichardy/comanda.orchestrator
      deploy_url_secret: ORCHESTRATOR_PRODUCTION_DEPLOY_URL
    secrets: inherit
